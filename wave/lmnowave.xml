<?xml version="1.0" encoding="UTF-8" ?>

<Module>
  <ModulePrefs
    title="lmnowave"
    title_url="http://danvk.org/"
    author="Dan Vanderkam"
    author_email="danvdk@gmail.com"
    thumbnail="http://danvk.org/lmnowave/thumbnail_120.png"
    screenshot="http://danvk.org/lmnowave/screenshot.png"
    description="Solve crossword puzzles with friends in Google Wave"
    width="800"
    height="375">
   <Require feature="rpc"/>
   <!-- <Require feature="wave" /> -->
   <Require feature="dynamic-height" />
  </ModulePrefs>

  <Content type="html">
  <![CDATA[
<html>
  <link rel="stylesheet" type="text/css" href="http://danvk.org/lmnowave/crossword.css"/>
<style type='text/css'>
body {
  margin: 0ex 1ex;
}
body, td, input {
  font-family: serif;
}

h3 {
  font-size: 100%;
  margin: 0;
}
</style>

<body>

<script src="http://danvk.org/lmnowave/common.js"></script>
<script src="http://danvk.org/lmnowave/console.js"></script>
<script src="http://danvk.org/lmnowave/crosswordui.js"></script>
<script src="http://danvk.org/lmnowave/cluesui.js"></script>
<script src="http://danvk.org/lmnowave/focusbox.js"></script>
<script src="http://danvk.org/lmnowave/roster.js"></script>
<script src="http://danvk.org/lmnowave/color.js"></script>
<script src="http://danvk.org/lmnowave/puzparser.js"></script>
<script src="http://danvk.org/lmnowave/lmnowave.js"></script>
<script src="http://danvk.org/lmnowave/builtins.js"></script>

<script src="https://hangoutsapi.talkgadget.google.com/hangouts/api/hangout.js?v=1.0" ></script>

<div id="upload" style="display:none">
  <div id="upload_supported" style="display:none;">
    <div id="dropbox" class="dropbox" >
    <img src="http://danvk.org/lmnowave/thumbnail_120.png" />
    <p><b>Drag a .puz file here to start playing.</b></p>
    </div>
    <p>Or choose a file: <input type="file" id="puz" onchange="addPuzToWave(this.files)" /></p>
    </form>
    <p>You can find links to many .puz files <a
    href="http://www.fleetingimage.com/wij/xyzzy/nyt-links.html">here</a>.
    <br/>Or, try one of these puzzles from the <a
    href="http://www.avclub.com/">A.V. Club</a>:</p>
  </div>

  <div id="upload_unsupported" style="display:none;">
    <table><tr>
    <td valign="top">
      <img src="http://danvk.org/lmnowave/thumbnail_120.png" />
    </td><td valign="middle">
      <p><b>Your browser does not support puzzle upload.</b></p>
      <p>Try loading this wave in a browser that does, such as <a
      href="http://www.mozilla.com/firefox/" target="_blank">Firefox
      3.6</a>.<br/> Or, try one of these puzzles from the <a
      href="http://www.avclub.com/">A.V. Club</a>:</p>
    </td>
    </tr></table>
  </div>

  <div id="builtins">
  </div>

  <script type="text/javascript">
  for (var i = 0; i < Builtins.length; i++) {
    var p = Builtins[i];
    var str = '<a href="javascript:setBuiltInPuz(' + i + ')"><img src="http://danvk.org/lmnowave/puzzle_16.png" />' + p['title'] + '</a>&nbsp; (by ' + p['author'] + '; <a href="' + p['link'] + '">original</a>)<br/>';
    document.getElementById("builtins").innerHTML += str;
  }

  function setBuiltInPuz(i) {
    gapi.hangout.data.submitDelta({'crossword': Builtins[i].data});
  }
  </script>
</div>

<!-- do onblur and onfocus mean anything to a table? -->
<div id="crossword_container" style="display:none">

<table cellspacing='0' cellpadding='0' id='toptable' >
  <tr valign="top"><td colspan=3>
    <table id="puzzle_info" width="100%"><tr>
      <td id="title"></td>
      <td id="author"></td>
      <td id="copyright"></td>
    </tr></table>
  </td></tr>

  <tr valign='top'>
    <td>
      <div id='current_clue'></div>
      <div id='crossword' style='margin-right: 2ex'></div>
    </td>
    <td><div id='clues'></div></td>
  </tr>
</table>
</div>

<div style="display:none;">
<table cellspacing='0' cellpadding='0' style='padding-top: 1ex' id='bottomtable'>
  <tr valign='top'>
    <td style='width:100%'><div id='console'></div></td>
  </tr>
</table>
</div>

<script type="text/javascript">
  gadgets.util.registerOnLoadHandler(function() {
    gapi.hangout.onApiReady.add(
      function(eventObj) {
        console.log('onApiReady fn called');
        if (eventObj.isApiReady) {
          realInit();
        }
      }
    );
  });

  function realInit() {
    // if (wave && wave.isInWaveContainer()) {
    //   wave.setStateCallback(stateUpdated);
    // }
    // gadgets.window.adjustHeight();
    console.log('in realInit');
    gapi.hangout.data.onStateChanged.add(stateUpdated);
    setHeight();
    stateUpdated();  // initialize state
  }

  // Set up the drag-and-drop interface.
  if (supportsUpload()) {
    var dropbox = document.getElementById("dropbox");
    var stop = function(e) { e.stopPropagation(); e.preventDefault(); };
    dropbox.addEventListener("dragenter", stop, false);
    dropbox.addEventListener("dragover", stop, false);
    dropbox.addEventListener("drop", function(e) {
      stop(e);
      addPuzToWave(e.dataTransfer.files);
    }, false);
    $('upload_supported').style.display = 'block';
  } else {
    $('upload_unsupported').style.display = 'block';
  }
</script>
</body>
  ]]>
  </Content>
</Module>
